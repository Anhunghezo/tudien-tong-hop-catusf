name: Release all dictionaries

on:
  workflow_dispatch:

  push:

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Setup Wine32
      run: |
        # sudo dpkg --add-architecture i386
        # sudo wget -nc -O /usr/share/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
        # sudo wget -nc -P /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/focal/winehq-focal.sources
        # sudo apt update
        # sudo apt install --install-recommends winehq-stable

    # - name: Setup Wine32
    #   run: |
    #     sudo apt install -f aptitude

    #     sudo apt-get install --allow-downgrades libpcre2-8-0=10.34-7
    #     sudo apt-get install --allow-downgrades libssl1.1=1.1.1f-1ubuntu2.1
    #     sudo apt-get install --allow-downgrades libssl1.1:i386=1.1.1f-1ubuntu2.1

    #     sudo aptitude install wine32

    - uses: actions/checkout@v3

    - name: Setup Ubuntu packages
      run: |
        ./bin/install_linux_packages.sh

    - name: Setup Python packages
      run: |
        pip install -r ./bin/requirements.txt

    - name: Build StarDict dictionaries
      run: |
        ./bin/convert2dict.sh

    - name: Build Epub dictionaries
      run: |
        ./bin/convert2epub.sh

    - name: Build Kobo dictionaries
      run: |
        ./bin/convert2kobo.sh

    - name: Build Lingvo dictionaries
      run: |
        ./bin/convert2lingvo.sh

    # - name: Build Kindle .mobi dictionaries
    #   run: |
    #     ./bin/createallhtml.sh
    #     ./bin/createallhtml-inflections.sh
    #     ./bin/createallmobi.sh
        
    - name: Create a new release draft
      id: create_release
      uses: ncipollo/release-action@v1
      with:
          artifacts: "./output/*.*,./output/kindle/*.*,./output/kobo/*.*,./output/lingvo/*.*,./output/epub/*.*"
          body: If you can read this, we have forgotten to fill in the changelog. Sorry!
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          draft: true
          name: Release ${{ github.ref }}

    - name: Upload assets
      id: upload-release-asset 
      uses: dwenegar/upload-release-assets@v1
      env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
            release_id: ${{ steps.create_release.outputs.id }}
            assets_path: ./output/*
