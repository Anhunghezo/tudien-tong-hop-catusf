name: Release all dictionaries

on:
  push:
    tags:
    - 'v*'

env:

jobs:
  build:

    runs-on: ubuntu-latest

    env:
      MGFXC_WINE_PATH: /home/runner/.winemonogame

    steps:
    - uses: actions/checkout@v3

    - name: Setup Ubuntu packages
      run: |
        ./bin/install_linux_packages.sh

    - name: Setup Python packages
      run: |
        pip install -r ./bin/requirements.txt

    - name: Setup Wine
      run: |
        sudo apt update
        sudo apt install wine64 p7zip-full
        wget -qO- https://raw.githubusercontent.com/MonoGame/MonoGame/master/Tools/MonoGame.Effect.Compiler/mgfxc_wine_setup.sh | sh

    - name: Build Kindle .mobi dictionaries
      run: |
        ./bin/createallmobi.sh
        zip ./output/kindle.zip ./output/kindle/*.mobi

    - name: Create a new release draft
        id: create_release
        uses: actions/create-release@v1
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
            tag_name: ${{ github.ref }}
            release_name: Release ${{ github.ref }}
            body: If you can read this, we have forgotten to fill in the changelog. Sorry!
            draft: true

    - name: Upload assets
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1.0.1
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ./output/kindle.zip
            asset_name: kindle.zip
            asset_content_type: application/zip
